<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Personal Notes</title>
    <link rel="icon" href="assets/note-taking-app-icon-in-illustration-vector.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        * {
            box-sizing: border-box;
            font-family: "Times New Roman"
        }

        body {
            margin: 0;
            background: #f2f4f7
        }

        .topbar {
            height: 52px;
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 0 20px;
            background: #fff;
            border-bottom: 1px solid #ddd;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .topbar button {
            padding: 6px 14px;
            border: none;
            border-radius: 6px;
            background: #2563eb;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
        }

        .topbar button:hover {
            background: #1d4ed8
        }

        .app {
            display: flex;
            margin-top: 52px
        }

        .sidebar {
            width: 260px;
            background: #fff;
            border-right: 1px solid #ddd;
            padding: 15px;
            height: calc(100vh - 52px);
            overflow: auto;
        }

        .editor-wrap {
            flex: 1;
            display: flex;
            justify-content: center
        }

        .editor {
            width: 900px;
            background: #fff;
            margin: 40px 0;
            padding: 80px 70px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, .1);
            border-radius: 12px;
        }

        #title {
            width: 100%;
            font-size: 40px;
            font-weight: bold;
            border: none;
            outline: none;
            margin-bottom: 30px;
        }

        #content {
            font-size: 20px;
            min-height: 1400px;
            outline: none
        }

        h1 {
            font-size: 34px;
            color: #0b3d91
        }

        h2 {
            font-size: 30px;
            color: #1f6f3c
        }

        h3 {
            font-size: 26px;
            color: #c8412b
        }

        p,
        li {
            font-size: 20px;
            line-height: 1.6
        }

        .toolbar {
            position: absolute;
            display: none;
            background: #1f2937;
            padding: 6px;
            border-radius: 8px;
            z-index: 2000;
        }

        .toolbar button {
            background: none;
            border: none;
            color: #fff;
            margin: 0 4px;
            cursor: pointer;
        }

        .resizable-wrapper {
            display: inline-block;
            position: relative
        }

        .resizable-wrapper img {
            max-width: 100%;
            display: block
        }

        .resizable-handle {
            width: 12px;
            height: 12px;
            background: #2563eb;
            position: absolute;
            right: -6px;
            bottom: -6px;
            cursor: se-resize;
            border-radius: 50%;
        }

        .outline-item {
            cursor: pointer;
            margin: 6px 0
        }

        .outline-h1 {
            font-weight: bold
        }

        .outline-h2 {
            margin-left: 14px
        }

        .outline-h3 {
            margin-left: 28px
        }

        .blink {
            animation: blink 1.5s
        }

        @keyframes blink {
            0% {
                background: yellow
            }

            100% {
                background: transparent
            }
        }
    </style>
</head>

<body>

    <div class="topbar">
        <button id="newBtn">New</button>
        <button id="saveBtn">Save</button>
        <button id="openBtn">Open</button>
        <button id="pdfBtn">PDF</button>
    </div>

    <div class="toolbar" id="toolbar">
        <button onclick="setBlock('p')">Text</button>
        <button onclick="setBlock('h1')">H1</button>
        <button onclick="setBlock('h2')">H2</button>
        <button onclick="setBlock('h3')">H3</button>
        <button onclick="cmd('bold')"><b>B</b></button>
        <button onclick="cmd('italic')"><i>I</i></button>
        <button onclick="insertImage()">ðŸ–¼</button>
    </div>

    <div class="app">
        <div class="sidebar">
            <h3>Outline</h3>
            <div id="outline"></div>
        </div>

        <div class="editor-wrap">
            <div class="editor">
                <input id="title" placeholder="Untitled">
                <div id="content" contenteditable="true">
                    <p><br></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const content = document.getElementById('content');
        const toolbar = document.getElementById('toolbar');
        const outline = document.getElementById('outline');
        const title = document.getElementById('title');

        function showToolbar() {
            const sel = window.getSelection();
            if (!sel.rangeCount || sel.isCollapsed) { toolbar.style.display = 'none'; return; }
            const r = sel.getRangeAt(0).getBoundingClientRect();
            toolbar.style.display = 'block';
            toolbar.style.top = r.top + window.scrollY - 45 + 'px';
            toolbar.style.left = r.left + 'px';
        }
        document.addEventListener('mouseup', showToolbar);
        document.addEventListener('keyup', showToolbar);

        function cmd(c) { document.execCommand(c); save(); updateOutline() }
        function setBlock(t) { document.execCommand('formatBlock', false, t); save(); updateOutline() }

        /* ---------- IMAGE ---------- */
        function insertImage() {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = 'image/*';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = () => {
                    const wrap = document.createElement('div');
                    wrap.className = 'resizable-wrapper';
                    const img = document.createElement('img');
                    img.src = reader.result;
                    const h = document.createElement('div');
                    h.className = 'resizable-handle';
                    wrap.append(img, h);

                    img.ondblclick = () => { if (confirm('Delete image?')) wrap.remove(); save(); }

                    h.onmousedown = e => {
                        e.preventDefault();
                        let w = img.offsetWidth;
                        let sx = e.clientX;
                        function move(ev) {
                            img.style.width = Math.max(80, w + ev.clientX - sx) + 'px';
                        }
                        function up() {
                            window.removeEventListener('mousemove', move);
                            window.removeEventListener('mouseup', up);
                            save();
                        }
                        window.addEventListener('mousemove', move);
                        window.addEventListener('mouseup', up);
                    };

                    const r = window.getSelection().getRangeAt(0);
                    r.insertNode(wrap);
                    r.insertNode(document.createElement('p'));
                    save();
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        /* ---------- FIXED OUTLINE (DOM ORDER) ---------- */
        function updateOutline() {
            outline.innerHTML = '';

            const headers = content.querySelectorAll('h1, h2, h3'); // DOM order

            headers.forEach(h => {
                const d = document.createElement('div');
                d.textContent = h.innerText || '(empty)';

                if (h.tagName === 'H1') d.className = 'outline-item outline-h1';
                if (h.tagName === 'H2') d.className = 'outline-item outline-h2';
                if (h.tagName === 'H3') d.className = 'outline-item outline-h3';

                d.onclick = () => {
                    h.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    h.classList.add('blink');
                    setTimeout(() => h.classList.remove('blink'), 1500);
                };
                outline.appendChild(d);
            });
        }

        function save() {
            localStorage.setItem('note', JSON.stringify({ t: title.value, c: content.innerHTML }));
        }
        function load() {
            const d = JSON.parse(localStorage.getItem('note'));
            if (d) { title.value = d.t; content.innerHTML = d.c; updateOutline(); }
        }

        async function exportPDF() {
            const { jsPDF } = window.jspdf;
            const clone = document.querySelector('.editor').cloneNode(true);
            const canvas = await html2canvas(clone, { scale: 3 });
            const img = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'pt', 'a4');
            const w = pdf.internal.pageSize.getWidth() - 40;
            const h = (canvas.height * w) / canvas.width;
            pdf.addImage(img, 'PNG', 20, 30, w, h);
            pdf.save((title.value || 'note') + '.pdf');
        }

        document.getElementById('newBtn').onclick = () => { title.value = ''; content.innerHTML = '<p><br></p>'; save(); updateOutline(); }
        document.getElementById('saveBtn').onclick = exportHTML;
        document.getElementById('openBtn').onclick = openHTML;
        document.getElementById('pdfBtn').onclick = exportPDF;

        function exportHTML() {
            const blob = new Blob([content.innerHTML], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'note.html'; a.click();
        }
        function openHTML() {
            const i = document.createElement('input');
            i.type = 'file'; i.accept = '.html';
            i.onchange = e => {
                const r = new FileReader();
                r.onload = () => { content.innerHTML = r.result; updateOutline(); save(); }
                r.readAsText(e.target.files[0]);
            };
            i.click();
        }

        content.oninput = () => { save(); updateOutline() };
        title.oninput = save;

        load();
    </script>

</body>

</html>